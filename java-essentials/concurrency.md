# 并发

## Snychronized关键字内部实现
* 对象头锁标志表示当前锁类型：无锁，偏向锁，轻量级锁，重量级锁。
* 偏向锁：对象头记录线程ID，表示该线程锁定
* 轻/重量级锁：对象头指向栈中所对象指针

## 轻重区分：
* 重量级锁：基于操作系统提供的互斥量实现的，需要切换上下文
* 轻量级锁：基于CAS实现的自旋锁

* 锁的膨胀：轻量级锁膨胀为重量级锁的过程

## 加锁过程：（比较繁琐，略）
加锁过程中，随着竞争的激烈，锁会升级：偏向锁->轻量级锁->重量级锁

升级的本质原因，主要考虑性能的优化，轻量级锁（基于CAS的自选锁）是循环等待，避免了线程的切换。轻量级锁适用于短时间的等待，而且这里的“短时间”应该小于线程的启停的时间，否则就得不偿失。如果锁的时间较长，则使用重量级锁比较合理。

* 适应性自选锁（Adaptive Spinning):比普通的自选锁稍微复杂一点，自选次数不是固定的，而是根据自选成功的计数来调整。
* 锁粗化（Lock coarsening）:虚拟机自动检测是否可以合并多次对同一个块的锁定过程，
* 锁消除：虚拟机根据代码逃逸技术，自动检测发现某些数据不会逃逸出当前线程，则自动消除锁操作。
